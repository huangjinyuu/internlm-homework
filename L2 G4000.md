# InternVL çš„éƒ¨ç½²ä¸å¾®è°ƒ

## 1. å¤šæ¨¡æ€æ¨¡å‹ åŸºç¡€

### 1.1 å¤šæ¨¡æ€å¤§æ¨¡å‹çš„å¸¸è§è®¾è®¡æ¨¡å¼

æˆ‘æ‰€ç†è§£çš„å¤šæ¨¡æ€å¤§æ¨¡å‹çš„å¸¸è§è®¾è®¡æ¨¡å¼ï¼š

![image](https://github.com/user-attachments/assets/8c445ae3-f3b3-4a59-a0a0-b280470f4da2)

å¤šæ¨¡æ€å¤§æ¨¡å‹çš„å·¥ä½œåŸç†ï¼š
1. ä»¥å¤§è¯­è¨€æ¨¡å‹ä¸ºåŸºç¡€æ¶æ„ï¼Œä½œä¸ºç»Ÿä¸€çš„æ¨ç†å’Œç”Ÿæˆéª¨å¹²ç½‘ç»œ
2. å¤šæ¨¡æ€è¾“å…¥å¤„ç†ï¼šé€šè¿‡å„è‡ªçš„ç¼–ç å™¨(encoder)+é€‚é…å™¨(adapter)çš„æ–¹å¼å¤„ç†å›¾ç‰‡ã€éŸ³é¢‘ç­‰å¤šæ¨¡æ€è¾“å…¥ï¼Œå°†ä¸åŒæ¨¡æ€å¯¹é½åˆ°è¯­è¨€æ¨¡å‹çš„è¯­ä¹‰ç©ºé—´
    - é€šè¿‡ä¸“é—¨çš„ç¼–ç å™¨(encoder)å¤„ç†å„ç±»è¾“å…¥ï¼š
      - å›¾åƒç¼–ç å™¨(å¦‚CLIP, ViT)
      - éŸ³é¢‘ç¼–ç å™¨(å¦‚Wav2Vec)
      - è§†é¢‘ç¼–ç å™¨ç­‰
    - å¯¹é½ç­–ç•¥çš„å¤šæ ·æ€§ï¼š
      - é€‚é…å™¨(adapter)å¯¹é½
      - æŠ•å½±å±‚å¯¹é½
      - äº¤å‰æ³¨æ„åŠ›å¯¹é½
3. ç‰¹å¾èåˆå’Œç”Ÿæˆ
    - å¤šæ¨¡æ€ç‰¹å¾çš„äº¤äº’å’Œèåˆï¼š
      - é€šè¿‡äº¤å‰æ³¨æ„åŠ›æœºåˆ¶å®ç°æ¨¡æ€é—´ä¿¡æ¯äº¤æ¢
      - å¤šå±‚æ¬¡çš„ç‰¹å¾èåˆ
    - è§£ç è¿‡ç¨‹ï¼š
      - åŸºäºèåˆç‰¹å¾çš„åºåˆ—ç”Ÿæˆ
      - ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„å¤šæ¨¡æ€ç†è§£

![image](https://github.com/user-attachments/assets/1e80b80c-e5ac-4fcf-9cef-09df7c2a8ec0)



### 1.2 InternVLçš„è®¾è®¡
ç®€è¦é˜…è¯»äº†InternVL1.5çš„[è®ºæ–‡](https://arxiv.org/pdf/2404.16821)

InternVL 1.5 æ¨¡å‹æ¶æ„ï¼š

![image](https://github.com/user-attachments/assets/c1d6a4e0-f94b-49ef-b44b-ec3778b4af3d)


InternVL 1.5 çš„è®­ç»ƒè¿‡ç¨‹:

1. åŸºç¡€æ¨¡å‹å‡†å¤‡:
    - è§†è§‰åŸºç¡€æ¨¡å‹: InternViT-6B
    - è¯­è¨€åŸºç¡€æ¨¡å‹: InternLM2-20B(Chatç‰ˆæœ¬)

2. è§†è§‰ç¼–ç å™¨çš„æŒç»­å­¦ä¹ (Continuous Learning)ä¼˜åŒ–:

    A. InternViT-6B-448px-V1.2 çš„ä¼˜åŒ–:
    - ç§»é™¤æœ€å 3 å±‚(ä»48å±‚å‡å°‘åˆ°45å±‚)
    - åˆ†è¾¨ç‡ä» 224 æå‡åˆ° 448
    - ä½¿ç”¨å›¾åƒæè¿°å’ŒOCRæ•°æ®é›†è®­ç»ƒ
    - æ­¤æ—¶æ˜¯ä¸ Nous-Hermes-2-Yi-34B é…åˆ
    
    B. InternViT-6B-448px-V1.5 çš„è¿›ä¸€æ­¥ä¼˜åŒ–:
    - åŸºäº V1.2 ç‰ˆæœ¬ç»§ç»­è®­ç»ƒ
    - æ‰©å±•åˆ°åŠ¨æ€ 448Ã—448 åˆ†è¾¨ç‡(1-12å—)
    - å¢å¼ºæ•°æ®è§„æ¨¡ã€è´¨é‡å’Œå¤šæ ·æ€§
    - æå‡ OCR èƒ½åŠ›å’Œé«˜åˆ†è¾¨ç‡å¤„ç†èƒ½åŠ›

3. ä¸¤é˜¶æ®µè®­ç»ƒæµç¨‹:

    A. é¢„è®­ç»ƒé˜¶æ®µ:
    - è®­ç»ƒç›®æ ‡: ä¼˜åŒ–è§†è§‰ç¼–ç å™¨å’Œ MLP æŠ•å½±å±‚
    - é¢„è®­ç»ƒæ•°æ®:
      - å›¾åƒæè¿° (53.9%)
      - OCR æ•°æ® (40.9%) 
      - æ£€æµ‹æ•°æ® (5.2%)
    
    B. å¾®è°ƒé˜¶æ®µ:
    - è®­ç»ƒç›®æ ‡: æ•´ä¸ªæ¨¡å‹ç«¯åˆ°ç«¯è®­ç»ƒ
    - å¾®è°ƒæ•°æ®ç±»å‹: å¤šæ ·åŒ–çš„ä¸‹æ¸¸ä»»åŠ¡æ•°æ®ï¼Œæé«˜å¤šæ¨¡æ€ç†è§£èƒ½åŠ›
      - å›¾åƒæè¿°
      - é€šç”¨é—®ç­”
      - ç§‘å­¦ç†è§£
      - å›¾è¡¨ç†è§£
      - æ•°å­¦æ¨ç†
      - çŸ¥è¯†é—®ç­”
      - OCR ä»»åŠ¡
      - æ–‡æ¡£ç†è§£
      - è§†è§‰å®šä½
      - å¤šè½®å¯¹è¯


ä¸€ä¸ªé‡è¦å‘ç°æ˜¯:

è®ºæ–‡ç‰¹åˆ«æåˆ°:"å€¼å¾—æ³¨æ„çš„æ˜¯,å°½ç®¡ InternVL 1.5 ä¸­çš„ LLM ä» Nous-Hermes-2-Yi-34B æ¢æˆäº† InternLM2-20B,ä½† InternViT ä»ç„¶ä¿æŒäº†ä¸æ–° LLM çš„å‡ºè‰²å…¼å®¹æ€§å’Œå¯ç§»æ¤æ€§ã€‚è¿™è¡¨æ˜ InternViT-6B åœ¨ MLLM é¢„è®­ç»ƒé˜¶æ®µå­¦ä¹ åˆ°çš„è§†è§‰ç‰¹å¾å…·æœ‰å¹¿æ³›çš„é€‚ç”¨æ€§,å¹¶ä¸ä¸ç‰¹å®šçš„ LLM ç´§å¯†ç»‘å®šã€‚"

è¿™è¯´æ˜:
1. è§†è§‰ç¼–ç å™¨çš„è®­ç»ƒæ˜¯ç›¸å¯¹ç‹¬ç«‹çš„
2. è®­ç»ƒå¥½çš„è§†è§‰ç¼–ç å™¨å¯ä»¥å’Œä¸åŒçš„LLMé…åˆä½¿ç”¨
3. è¿™ç§è®¾è®¡å¢åŠ äº†æ¨¡å‹çš„çµæ´»æ€§å’Œå¯å¤ç”¨æ€§


## 2. é…ç¯å¢ƒ
`xtuner` çš„ç¯å¢ƒï¼šå¤ç”¨æ­¤å‰ `L1 G5000` è¯¾ç¨‹é…å¥½çš„xtunerç¯å¢ƒï¼Œé¢å¤–æ‰§è¡Œä¸‹é¢ä¸€è¡Œå³å¯ï¼š
```
pip install -U 'xtuner[deepspeed]' timm==1.0.9
```

`lmdeploy` çš„ç¯å¢ƒï¼š
```
pip install lmdeploy gradio==4.44.1 timm==1.0.9
```

## 3. éƒ¨ç½²
äº†è§£LMDeployéƒ¨ç½²å¤šæ¨¡æ€å¤§æ¨¡å‹çš„æ ¸å¿ƒä»£ç ï¼Œå¹¶

### 3.1 LMDeployéƒ¨ç½²å¤šæ¨¡æ€å¤§æ¨¡å‹

lmdeployæ¨ç†çš„æ ¸å¿ƒä»£ç å¯ä»¥æ€»ç»“ä¸ºï¼š
1. ğŸ”§ åˆå§‹åŒ–é…ç½®ï¼ˆåˆ›å»ºç®¡çº¿ï¼‰
2. âš™ï¸ è®¾ç½®å‚æ•°ï¼ˆæ§åˆ¶ç”Ÿæˆï¼‰
3. ğŸ—£ï¸ å¼€å§‹å¯¹è¯ï¼ˆé¦–æ¬¡å¯¹è¯ï¼‰
4. ğŸ’¬ æŒç»­å¯¹è¯ï¼ˆåç»­å¯¹è¯ï¼‰

```python
"""
LMDeploy å¤šæ¨¡æ€å¯¹è¯ç³»ç»Ÿç¤ºä¾‹
è¯¥ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ LMDeploy æ„å»ºä¸€ä¸ªæ”¯æŒå›¾æ–‡å¤šè½®å¯¹è¯çš„ç³»ç»Ÿ
"""

## 1. å¯¼å…¥å¿…è¦çš„åŒ…
# lmdeploy æ ¸å¿ƒåŠŸèƒ½
from lmdeploy import pipeline, TurbomindEngineConfig, GenerationConfig
# å›¾åƒåŠ è½½å·¥å…·
from lmdeploy.vl import load_image

## 2. åˆå§‹åŒ–æ¨¡å‹å’Œé…ç½®
# è®¾ç½®æ¨¡å‹è·¯å¾„
model_path = "your_model_path"
# åˆ›å»ºæ¨ç†ç®¡çº¿
# TurbomindEngineConfig: æ¨ç†å¼•æ“é…ç½®
pipe = pipeline(model_path,
               backend_config=TurbomindEngineConfig(session_len=8192))

## 3. å‡†å¤‡è¾“å…¥æ•°æ®
# åŠ è½½å›¾ç‰‡ (æ”¯æŒå¤šç§æ ¼å¼å¦‚ jpg, png)
# ä¹Ÿå¯ä»¥ä½¿ç”¨ PIL.Image.open() åŠ è½½
image = load_image('your_image_path')

## 4. è®¾ç½®ç”Ÿæˆå‚æ•°
# GenerationConfig: æ§åˆ¶æ–‡æœ¬ç”Ÿæˆçš„è¡Œä¸º
gen_config = GenerationConfig(
    top_p=0.8,          # é‡‡æ ·æ—¶çš„ç´¯ç§¯æ¦‚ç‡é˜ˆå€¼
    temperature=0.8     # æ¸©åº¦å‚æ•°ï¼Œè°ƒèŠ‚è¾“å‡ºçš„éšæœºæ€§
)

## 5. å¼€å§‹é¦–è½®å¯¹è¯
# pipe.chat(): å¯åŠ¨å¯¹è¯
# - è¾“å…¥: ('æç¤ºè¯', å›¾ç‰‡å¯¹è±¡)
# - gen_config: ä¸Šé¢è®¾ç½®çš„ç”Ÿæˆå‚æ•°
# è¿”å›: session å¯¹è±¡ï¼ŒåŒ…å«å¯¹è¯çŠ¶æ€
sess = pipe.chat(
    ('describe this image', image),  # å…ƒç»„å½¢å¼ä¼ å…¥æç¤ºè¯å’Œå›¾ç‰‡
    gen_config=gen_config
)
# æ‰“å°æ¨¡å‹å›å¤
print("æ¨¡å‹å›å¤:", sess.response.text)

## 6. ç»§ç»­å¤šè½®å¯¹è¯
# ä¼ å…¥:
# - æ–°çš„é—®é¢˜
# - session: ä¸Šä¸€è½®è¿”å›çš„ä¼šè¯çŠ¶æ€ï¼Œä¿æŒå¯¹è¯è¿è´¯æ€§
# - gen_config: ç”Ÿæˆå‚æ•°
sess = pipe.chat(
    'What is the woman doing?',  # æ–°çš„é—®é¢˜
    session=sess,                # ä¼ å…¥ä¸Šä¸€è½®å¯¹è¯çš„ session
    gen_config=gen_config       # ä¿æŒç›¸åŒçš„ç”Ÿæˆå‚æ•°
)
# æ‰“å°æ–°çš„å›å¤
print("æ¨¡å‹æ–°å›å¤:", sess.response.text)
```

### 3.2 WebUI
è¿è¡Œæä¾›çš„gradioä»£ç ï¼Œåœ¨UIç•Œé¢ä½“éªŒä¸InternVL2çš„å¯¹è¯ï¼š

åœ¨å¾®è°ƒä¹‹å‰ï¼Œæ¨¡å‹çš„è¡¨ç°æœ‰ç‚¹éš¾ç»·ã€‚

![image](https://github.com/user-attachments/assets/8d6ab343-563b-4992-adcc-ca0ee15fc63d)

![image](https://github.com/user-attachments/assets/e5bf9211-048d-47ab-819b-0c2e56a2173c)


## 4. å¾®è°ƒ
äº†è§£XTunerï¼Œå¹¶åˆ©ç”¨ç»™å®šæ•°æ®é›†å¾®è°ƒInternVL2-2Båï¼Œå†æ¬¡å¯åŠ¨UIç•Œé¢ï¼Œä½“éªŒæ¨¡å‹ç¾é£Ÿé‰´èµèƒ½åŠ›çš„å˜åŒ–ã€‚

### 4.1 å¾®è°ƒé…ç½®

1. è®­ç»ƒç­–ç•¥ï¼š
    - åªåœ¨è¯­è¨€æ¨¡å‹éƒ¨åˆ†åŠ å…¥ LoRA è¿›è¡Œè®­ç»ƒ
    - è§†è§‰ç¼–ç å™¨å®Œå…¨å†»ç»“ï¼Œä¸”æ²¡æœ‰ä½¿ç”¨ LoRA
    - LoRA é…ç½®ï¼š
      - åœ¨è¯­è¨€æ¨¡å‹éƒ¨åˆ†ä½¿ç”¨äº† LoRA
      - rank(r) = 128
      - lora_alpha = 256
      - dropout = 0.05
      - æ³¨é‡Šæ‰äº†è§†è§‰ç¼–ç å™¨çš„ LoRA é…ç½®

2. è®­ç»ƒè¶…å‚æ•°ï¼š
    - æ‰¹æ¬¡å¤§å°ï¼š4
    - æ¢¯åº¦ç´¯ç§¯ï¼š2 æ¬¡
    - æœ€å¤§è®­ç»ƒè½®æ¬¡ï¼š10 epochs
    - å­¦ä¹ ç‡ï¼š3e-5
    - ä¼˜åŒ–å™¨ï¼šAdamW (Î²1=0.9, Î²2=0.999)
    - æƒé‡è¡°å‡ï¼š0.05
    - ä½¿ç”¨äº†æ··åˆç²¾åº¦è®­ç»ƒ (AmpOptimWrapper)

3. å­¦ä¹ ç‡è°ƒåº¦ï¼š
    - ä½¿ç”¨äº†ä¸¤é˜¶æ®µå­¦ä¹ ç‡è°ƒåº¦ï¼š
      1. warmupé˜¶æ®µï¼šLinearLRï¼Œçƒ­èº«æ¯”ä¾‹ä¸º 3% çš„æ€»è½®æ¬¡
      2. ä¸»è¦è®­ç»ƒé˜¶æ®µï¼šCosineAnnealingLRï¼Œä»çƒ­èº«ç»“æŸåˆ°è®­ç»ƒç»“æŸ

4. æ•°æ®å¤„ç†ï¼š
    - æœ€å¤§åºåˆ—é•¿åº¦ï¼š8192 tokens
    - ä½¿ç”¨ LengthGroupedSampler è¿›è¡Œé‡‡æ ·
    - è®¾ç½®äº† 4 ä¸ªæ•°æ®åŠ è½½å·¥ä½œè¿›ç¨‹

### 4.2 äº†è§£æ•°æ®é›†
æ˜¯ä¸€ä¸ªä¸­é¤ç¾é£Ÿç›¸å…³çš„é—®ç­”å¤šæ¨¡æ€æ•°æ®é›†ã€‚

é˜…è¯»æ•°æ®çš„`sivqa_llava.json `æ–‡ä»¶ï¼Œå¯ä»¥çœ‹å‡ºï¼š

- æ¯ä¸ªæ ·æœ¬åŒ…å«ï¼š
  - ä¸€å¼ é£Ÿç‰©å›¾ç‰‡
  - ä¸€è½®é—®ç­”å¯¹è¯ï¼ˆhuman æé—®ï¼Œgpt å›ç­”ï¼‰
 
```python
[
    {
        "image": "å›¾ç‰‡ç›¸å¯¹è·¯å¾„",
        "conversations": [
            {
                "from": "human/gpt",  # å¯¹è¯è§’è‰²
                "value": "å¯¹è¯å†…å®¹"    # åŒ…å«é—®é¢˜æˆ–ç­”æ¡ˆ
            },
            ...
        ]
    },
    ...
]
```





å…·ä½“å¤„ç†æµç¨‹ï¼š

1. å›¾åƒå¤„ç†ï¼š
    - å›¾ç‰‡ä¼šè¢«è§†è§‰ç¼–ç å™¨å•ç‹¬å¤„ç†ï¼Œè½¬æ¢æˆè§†è§‰ç‰¹å¾ï¼ˆvisual featuresï¼‰
    - InternVL ä½¿ç”¨çš„æ˜¯ç±» CLIP çš„è§†è§‰ç¼–ç å™¨ï¼Œä¼šå°†å›¾ç‰‡ç¼–ç æˆå›ºå®šç»´åº¦çš„ç‰¹å¾å‘é‡
```python
# ä¼ªä»£ç è¡¨ç¤º
image = load_image("images/14456664_217_IMG_3854.jpeg")
# é¢„å¤„ç†ï¼šè°ƒæ•´å¤§å°ã€è£å‰ªã€æ ‡å‡†åŒ–ç­‰
processed_image = preprocess(image)
# é€šè¿‡è§†è§‰ç¼–ç å™¨è·å–ç‰¹å¾
image_features = vision_encoder(processed_image)
```

2. æ–‡æœ¬å¤„ç†ï¼š
```python
# ä½¿ç”¨æ¨¡æ¿æ ¼å¼åŒ–å¯¹è¯
formatted_text = PROMPT_TEMPLATE.internlm2_chat(
    human="å›¾ç‰‡ä¸­çš„é£Ÿç‰©é€šå¸¸å±äºå“ªä¸ªèœç³»?\n<image>",
    assistant="æ–°ç–†èœï¼Œå›¾ä¸­çš„èœæ˜¯çƒ¤ç¾Šè‚‰ä¸²"
)

# è½¬æ¢ä¸ºtoken ids
input_ids = tokenizer(formatted_text)

# åˆ›å»ºæ ‡ç­¾ï¼ˆ-100è¡¨ç¤ºä¸è®¡ç®—lossçš„ä½ç½®ï¼‰
labels = input_ids.clone()
labels[ï¼šhuman_text_end] = -100  # äººç±»é—®é¢˜éƒ¨åˆ†ä¸è®¡ç®—loss
```

3. æœ€ç»ˆæ‰¹å¤„ç†ï¼š
```python
batch = {
    "image_features": torch.stack([sample1_img, sample2_img, ...]),  # [B, num_patches, hidden_size]
    "input_ids": torch.stack([sample1_ids, sample2_ids, ...]),      # [B, seq_len]
    "attention_mask": torch.stack([sample1_mask, sample2_mask, ...]),
    "labels": torch.stack([sample1_labels, sample2_labels, ...])
}
```

æœ€ç»ˆï¼Œæ¨¡å‹ä¼šï¼š
1. ä½¿ç”¨è§†è§‰ç¼–ç å™¨å¤„ç† image_features
2. ä½¿ç”¨è¯­è¨€æ¨¡å‹å¤„ç† input_ids
3. å°†ä¸¤ç§æ¨¡æ€çš„ç‰¹å¾èåˆ
4. ç”Ÿæˆå›ç­”å¹¶è®¡ç®—ä¸ labels çš„æŸå¤±

è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆé…ç½®æ–‡ä»¶ä¸­åªè®­ç»ƒè¯­è¨€æ¨¡å‹çš„ LoRAï¼šä¸»è¦çš„é€‚é…å·¥ä½œæ˜¯åœ¨å¤šæ¨¡æ€èåˆåçš„è¯­è¨€ç”Ÿæˆéƒ¨åˆ†ã€‚



### 4.3 å¯åŠ¨å¾®è°ƒ

XTunerä½¿ç”¨æµç¨‹ï¼š
1. å‡†å¤‡å¥½å¾®è°ƒçš„æ•°æ®
2. å†™å¥½å¾®è°ƒé…ç½®æ–‡ä»¶
3. å¼€è·‘ï¼

ä½¿ç”¨è¯¾ç¨‹æä¾›çš„é…ç½®æ–‡ä»¶ï¼Œæ˜¾å­˜å ç”¨åœ¨32Gå·¦å³ï¼š

![image](https://github.com/user-attachments/assets/c362773f-bd39-45ad-b2d9-e77b0aab77c1)

è®­ç»ƒç»“æŸï¼Œå…±ç”¨æ—¶1h33minï¼š

![image](https://github.com/user-attachments/assets/10805a6f-7b37-4672-b763-fed7d3f418c0)

loraæ–‡ä»¶288MBï¼š
![image](https://github.com/user-attachments/assets/9ed9a783-bfad-47d4-8840-0e36ce67c608)


### 4.3 æ£€éªŒå¾®è°ƒæ•ˆæœ

åœ¨ `xtuner` çš„ç¯å¢ƒä¸‹è¿›è¡Œæ¨¡å‹è½¬æ¢ã€‚

ç„¶åè¿è¡ŒWebUIï¼š

![image](https://github.com/user-attachments/assets/ffb9fcac-6f79-4f91-afa4-d523da836755)

![image](https://github.com/user-attachments/assets/3ed8b2b3-2710-4588-bbdf-80d6a36afb43)


